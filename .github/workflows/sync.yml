name: Upstream Sync

permissions:
  contents: write

on:
  schedule:
    - cron: "0 0 * * *" # 每天 UTC 时间 0点 (北京时间早上8点) 执行一次
  workflow_dispatch: # 允许手动点击按钮触发

jobs:
  sync_latest_from_upstream:
    name: Sync latest commits from upstream repo
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork }} # 只有 Fork 的仓库才执行

    steps:
      # 第一步：检出代码
      - name: Checkout target repo
        uses: actions/checkout@v3

      # 第二步：运行同步动作
      - name: Sync upstream changes
        id: sync
        uses: aormsby/Fork-Sync-With-Upstream-action@v3.4
        with:
          # ⚠️【必填】这里改成原作者的仓库地址 (用户名/仓库名)
          upstream_sync_repo: byJoey/cfnew
          # ⚠️【选填】原仓库的分支，一般是 main 或 master
          upstream_sync_branch: main
          # ⚠️【选填】你想要更新的自己仓库的分支
          target_sync_branch: main
          # Token 设置，保持默认即可
          target_repo_token: ${{ secrets.GITHUB_TOKEN }}
          # 设置为 false 表示直接合并，设置为 true 表示只测试不合并
          test_mode: false
          
      - name: Modify files and Push changes
        # 只有当同步成功后，才执行这一步
        if: steps.sync.outputs.has_new_commits == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "正在执行文件操作..."

          # 1. 核心操作：将 "少年你相信光吗" 重命名为 "_worker.js" (这是 CF Pages 运行的入口)
          # 使用引号包裹文件名，防止因为文件名里的空格或特殊字符报错
          if [ -f "少年你相信光吗" ]; then
            mv -f "少年你相信光吗" "_worker.js"
            echo "成功重命名 _worker.js"
          else
            echo "警告：未找到源文件 '少年你相信光吗'，可能文件名已变或无需重命名"
          fi

          # 2. 清理操作：删除多余的说明文件 (原代码用的 mv 没加目标，这里改为 rm 删除)
          # 如果你想保留它们，请删掉下面的行
          rm -f "README.md"
          rm -f "snippets"
          rm -f "明文源吗"
          rm -f "فارسی.md"

          # 3. 配置 Git 并提交
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add .
          git commit -m "Auto: Rename to _worker.js and cleanup" || echo "No changes to commit"
          git push      # =========================================================
      # 第三步：检查是否有冲突（可选）
      - name: Sync check
        if: failure()
        run: |
          echo "[Error] 由于冲突，同步失败。请手动解决冲突。"
          exit 1
